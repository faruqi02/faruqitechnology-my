<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatial Task Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* THEME VARIABLES */
        :root {
            --grid-size: 40px;
            --bg-color: #f0f2f5;
            --grid-color: #e0e0e0;
            --toolbar-bg: rgba(255, 255, 255, 0.9);
            --card-bg: #ffffff;
            --text-main: #222222;
            --text-sub: #444444;
            --border-color: #cccccc;
            --primary-btn: #222222;
            --shadow: rgba(0, 0, 0, 0.1);
            --accent: #007bff;
            --danger: #ff4d4d;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1b;
            --grid-color: #2d2d2e;
            --toolbar-bg: rgba(30, 30, 31, 0.9);
            --card-bg: #2d2d2e;
            --text-main: #e1e1e1;
            --text-sub: #b1b1b1;
            --border-color: #444444;
            --primary-btn: #444444;
            --shadow: rgba(0, 0, 0, 0.4);
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-color);
            background-image:
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: var(--grid-size) var(--grid-size);
            min-height: 100vh;
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }

        /* LASSO STYLING */
        #lasso {
            position: absolute;
            border: 1px solid var(--accent);
            background: rgba(0, 123, 255, 0.1);
            pointer-events: none;
            display: none;
            z-index: 10000;
        }

        /* TOOLBAR */
        #toolbar {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 12px;
            align-items: center;
            background: var(--toolbar-bg);
            padding: 10px 15px;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        button,
        select {
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-main { background: var(--primary-btn); color: white; }
        .btn-sub { background: var(--card-bg); color: var(--text-main); border: 1px solid var(--border-color); }
        .btn-danger { background: var(--card-bg); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background: var(--danger); color: #ffffff; }

        select {
            background: var(--card-bg);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            min-width: 120px;
        }

        /* TASK CARDS */
        .task-card {
            position: absolute;
            width: 240px;
            min-height: 160px;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-sizing: border-box;
            cursor: grab;
            box-shadow: 0 4px 15px var(--shadow);
            display: flex;
            flex-direction: column;
            border-left: 8px solid var(--accent);
            user-select: none;
            overflow: hidden; /* Keeps content inside during resize */
        }

        .task-card.selected {
            outline: 2px solid var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }

        .title-input {
            background: transparent;
            border: none;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
            outline: none;
            width: 100%;
            color: var(--text-main);
        }

        .task-textarea {
            background: transparent;
            border: none;
            resize: none;
            font-size: 14px;
            color: var(--text-sub);
            outline: none;
            width: 100%;
            flex: 1;
            line-height: 1.5;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--grid-color);
        }

        /* RESIZE HANDLE */
        .resizer {
            width: 15px;
            height: 15px;
            border-radius: 0 0 12px 0;
            background: linear-gradient(135deg, transparent 50%, var(--border-color) 50%);
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
        }

        .color-picker {
            border: none;
            width: 24px;
            height: 24px;
            cursor: pointer;
            background: none;
        }

        .delete-btn {
            color: var(--danger);
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
        }

        /* ZOOM CONTROLS */
        .zoom-controls {
            position: fixed;
            bottom: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1001;
        }

        .zoom-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--toolbar-bg);
            color: var(--text-main);
            box-shadow: 0 4px 10px var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 1px solid var(--border-color);
        }
        
        #canvas {
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
        }

        /* MODAL POPUP STYLING */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-box {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-main);
            box-sizing: border-box;
            outline: none;
            display: none;
        }

        @media (max-width: 768px) {
            #toolbar { top: auto; bottom: 20px; left: 10px; right: 10px; flex-wrap: wrap; justify-content: center; padding: 8px; gap: 8px; }
            button, select { padding: 8px 12px; font-size: 13px; flex-grow: 1; justify-content: center; }
            .zoom-controls { bottom: 140px; }
            .task-card { width: 180px; }
        }
    </style>
</head>

<body onmousedown="initLasso(event)">

    <div id="lasso"></div>

    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalTitle">Confirm Action</h3>
            <p id="modalMessage"></p>
            <input type="text" id="modalInput" class="modal-input">
            <div style="display:flex; justify-content:center; gap:12px;">
                <button class="btn-sub" onclick="handleModalResponse(false)">Cancel</button>
                <button id="modalConfirmBtn" class="btn-main" onclick="handleModalResponse(true)">Confirm</button>
            </div>
        </div>
    </div>

    <div id="toolbar" onmousedown="event.stopPropagation()">
        <button class="btn-main" onclick="createTask()">
            <i class="bi bi-plus-lg"></i> Add New Task
        </button>
        <select id="userSelect"></select>
        <button class="btn-sub" onclick="addUser()">
            <i class="bi bi-person-plus"></i> Add User
        </button>
        <button class="btn-sub" onclick="editUser()">
            <i class="bi bi-pencil-square"></i> Edit User
        </button>
        <button class="btn-danger" onclick="deleteUser()">
            <i class="bi bi-trash3"></i> Delete User
        </button>
        <button id="themeToggle" class="btn-sub" onclick="toggleTheme()">
            <i id="themeIcon" class="bi bi-sun-fill"></i>
        </button>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="applyZoom(0.1)"><i class="bi bi-plus-lg"></i></button>
        <button class="zoom-btn" onclick="applyZoom(-0.1)"><i class="bi bi-dash-lg"></i></button>
        <button class="zoom-btn" style="font-size: 12px;" onclick="scale = 1; canvas.style.transform = 'scale(1)';">1:1</button>
    </div>

    <div id="canvas"></div>

    <script>
        const gridSize = 40;
        const canvas = document.getElementById('canvas');
        const userSelect = document.getElementById('userSelect');
        const lasso = document.getElementById('lasso');
        const modalOverlay = document.getElementById('modalOverlay');
        const modalInput = document.getElementById('modalInput');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        
        let modalResolver = null;
        let currentUser = localStorage.getItem('lastUser') || 'Personal';
        let allUserData = JSON.parse(localStorage.getItem('spatialTaskData')) || { 'Personal': [], 'Work': [] };
        let selectedTasks = new Set();
        let scale = 1;

        // --- LASSO SELECTION ---
        function initLasso(e) {
            if (e.target !== document.body && e.target !== canvas) return;
            if (!e.shiftKey) {
                selectedTasks.forEach(id => {
                    const el = document.querySelector(`[data-id="${id}"]`);
                    if (el) el.classList.remove('selected');
                });
                selectedTasks.clear();
            }
            const startX = e.clientX;
            const startY = e.clientY;
            lasso.style.display = 'block';
            lasso.style.width = '0px'; lasso.style.height = '0px';

            function onMouseMove(moveEvent) {
                const currentX = moveEvent.clientX; const currentY = moveEvent.clientY;
                const left = Math.min(startX, currentX); const top = Math.min(startY, currentY);
                const width = Math.abs(currentX - startX); const height = Math.abs(currentY - startY);
                lasso.style.left = left + 'px'; lasso.style.top = top + 'px';
                lasso.style.width = width + 'px'; lasso.style.height = height + 'px';
                document.querySelectorAll('.task-card').forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const cardId = parseInt(card.dataset.id);
                    const isInside = (rect.left < left + width && rect.left + rect.width > left && rect.top < top + height && rect.top + rect.height > top);
                    if (isInside) { card.classList.add('selected'); selectedTasks.add(cardId); }
                    else if (!e.shiftKey) { card.classList.remove('selected'); selectedTasks.delete(cardId); }
                });
            }
            function onMouseUp() { lasso.style.display = 'none'; document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp); }
            document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
        }

        // --- UNIVERSAL MODAL ---
        async function showModal({ title, message, type = 'confirm', defaultValue = "" }) {
            modalTitle.innerText = title; modalMessage.innerText = message || "";
            modalInput.value = defaultValue; modalInput.style.display = (type === 'prompt') ? 'block' : 'none';
            modalConfirmBtn.className = (type === 'danger') ? 'btn-danger' : 'btn-main';
            modalOverlay.style.display = 'flex';
            return new Promise(r => modalResolver = r);
        }
        function handleModalResponse(confirmed) {
            modalOverlay.style.display = 'none';
            if (!confirmed) return modalResolver(null);
            modalResolver(modalInput.style.display === 'block' ? modalInput.value : true);
        }

        // --- TASK LOGIC ---
        function createTask() {
            const id = Date.now();
            const newTask = { id, title: 'New Task', desc: 'Details...', color: '#007bff', x: 120, y: 120, w: 240, h: 120 };
            allUserData[currentUser].push(newTask);
            renderTask(newTask);
            saveAll();
        }

        function renderTask(task) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.style.left = task.x + 'px'; card.style.top = task.y + 'px';
            card.style.width = (task.w || 240) + 'px'; card.style.height = (task.h || 120) + 'px';
            card.style.borderLeftColor = task.color;
            card.dataset.id = task.id;
            card.innerHTML = `
                <input type="text" class="title-input" value="${task.title}" onchange="updateTask(${task.id}, 'title', this.value)">
                <textarea class="task-textarea" oninput="updateTask(${task.id}, 'desc', this.value)">${task.desc}</textarea>
                <div class="card-footer">
                    <input type="color" class="color-picker" value="${task.color}" oninput="updateTask(${task.id}, 'color', this.value); this.closest('.task-card').style.borderLeftColor = this.value">
                    <span class="delete-btn" onclick="deleteTask(${task.id})"><i class="bi bi-trash-fill"></i> REMOVE</span>
                </div>
                <div class="resizer"></div>`;
            canvas.appendChild(card);
            makeDraggable(card);
            makeResizable(card);
        }

        // --- RESIZE LOGIC (SNAP TO GRID) ---
        function makeResizable(card) {
            const resizer = card.querySelector('.resizer');
            resizer.addEventListener('mousedown', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                let startX = e.clientX;
                let startY = e.clientY;
                let startW = card.offsetWidth;
                let startH = card.offsetHeight;

                const onMove = (e) => {
                    let currentW = startW + (e.clientX - startX) / scale;
                    let currentH = startH + (e.clientY - startY) / scale;
                    card.style.width = currentW + 'px';
                    card.style.height = currentH + 'px';
                };

                const onEnd = () => {
                    // Snap to grid
                    let finalW = Math.round(card.offsetWidth / gridSize) * gridSize;
                    let finalH = Math.round(card.offsetHeight / gridSize) * gridSize;
                    // Min size limit (1 grid cell)
                    finalW = Math.max(gridSize * 2, finalW);
                    finalH = Math.max(gridSize * 2, finalH);

                    card.style.width = finalW + 'px';
                    card.style.height = finalH + 'px';
                    
                    updateTask(parseInt(card.dataset.id), 'size', { w: finalW, h: finalH });
                    
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onEnd);
                };

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
            });
        }

        // --- DRAG LOGIC ---
        function makeDraggable(el) {
            let p1 = 0, p2 = 0, p3 = 0, p4 = 0;
            const onStart = (e) => {
                if (['INPUT', 'TEXTAREA', 'SPAN', 'I'].includes(e.target.tagName) || e.target.className === 'resizer') return;
                const coords = e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
                p3 = coords.x; p4 = coords.y;
                const elId = parseInt(el.dataset.id);
                if (!selectedTasks.has(elId)) {
                    document.querySelectorAll('.task-card').forEach(c => c.classList.remove('selected'));
                    selectedTasks.clear(); selectedTasks.add(elId); el.classList.add('selected');
                }
                const dragItems = [];
                selectedTasks.forEach(id => {
                    const itemEl = document.querySelector(`[data-id="${id}"]`);
                    if (itemEl) dragItems.push({ el: itemEl, x: itemEl.offsetLeft, y: itemEl.offsetTop });
                });
                const onMove = (e) => {
                    const moveCoords = e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
                    p1 = (p3 - moveCoords.x) / scale; p2 = (p4 - moveCoords.y) / scale;
                    p3 = moveCoords.x; p4 = moveCoords.y;
                    dragItems.forEach(item => {
                        item.x -= p1; item.y -= p2;
                        item.el.style.left = item.x + "px"; item.el.style.top = item.y + "px";
                    });
                };
                const onEnd = () => {
                    dragItems.forEach(item => {
                        let fx = Math.round(item.el.offsetLeft / gridSize) * gridSize;
                        let fy = Math.round(item.el.offsetTop / gridSize) * gridSize;
                        item.el.style.left = fx + "px"; item.el.style.top = fy + "px";
                        updateTask(parseInt(item.el.dataset.id), 'pos', { x: fx, y: fy });
                    });
                    document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onEnd);
                };
                document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd);
            };
            el.addEventListener('mousedown', onStart);
        }

        // --- UTILS ---
        function updateTask(id, f, v) {
            const t = allUserData[currentUser].find(x => x.id === id);
            if (!t) return;
            if (f === 'pos') { t.x = v.x; t.y = v.y; }
            else if (f === 'size') { t.w = v.w; t.h = v.h; }
            else { t[f] = v; }
            saveAll();
        }
        function saveAll() { localStorage.setItem('spatialTaskData', JSON.stringify(allUserData)); localStorage.setItem('lastUser', currentUser); }
        async function deleteTask(id) {
            if (await showModal({ title: "Delete Task", message: "Discard card?", type: 'danger' })) {
                allUserData[currentUser] = allUserData[currentUser].filter(t => t.id !== id);
                document.querySelector(`[data-id="${id}"]`).remove(); saveAll();
            }
        }
        function applyZoom(delta) { scale = Math.min(Math.max(0.3, scale + delta), 3); canvas.style.transform = `scale(${scale})`; }
        function toggleTheme() {
            const target = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
            document.getElementById('themeIcon').className = target === 'dark' ? 'bi bi-moon-stars-fill' : 'bi bi-sun-fill';
        }
        function refreshUserDropdown() {
            userSelect.innerHTML = '';
            Object.keys(allUserData).forEach(u => {
                const opt = document.createElement('option'); opt.value = u; opt.textContent = u;
                if (u === currentUser) opt.selected = true; userSelect.appendChild(opt);
            });
        }
        userSelect.onchange = (e) => { currentUser = e.target.value; canvas.innerHTML = ''; allUserData[currentUser].forEach(renderTask); saveAll(); };
        
        async function addUser() {
            const n = await showModal({ title: "New Workspace", type: 'prompt' });
            if (n && !allUserData[n]) { allUserData[n] = []; currentUser = n; refreshUserDropdown(); canvas.innerHTML = ''; saveAll(); }
        }

        async function editUser() {
            const newName = await showModal({ title: "Rename Workspace", message: "Enter a new name for this workspace:", type: 'prompt', defaultValue: currentUser });
            if (newName && newName !== currentUser) {
                if (allUserData[newName]) {
                    alert("A workspace with that name already exists.");
                    return;
                }
                allUserData[newName] = allUserData[currentUser];
                delete allUserData[currentUser];
                currentUser = newName;
                refreshUserDropdown();
                saveAll();
            }
        }

        async function deleteUser() {
            if (Object.keys(allUserData).length <= 1) return;
            if (await showModal({ title: "Delete User", type: 'danger' })) {
                delete allUserData[currentUser]; currentUser = Object.keys(allUserData)[0];
                refreshUserDropdown(); canvas.innerHTML = ''; allUserData[currentUser].forEach(renderTask); saveAll();
            }
        }
        window.onload = () => { if(localStorage.getItem('theme') === 'dark') toggleTheme(); refreshUserDropdown(); allUserData[currentUser].forEach(renderTask); };
    </script>
</body>
</html>